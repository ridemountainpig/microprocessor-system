//
// LCD_Bmp : display Logo Bitmap on LCD
//
// Bitmap Creation:
// Step 1. use Paint to draw 128x64 bitmap
// Step 2. use bmp2asm to convert bitmap into hex
// Step 3. cut hex code paste into char array Bitmap[128*8]
// Step 4. build & download code to learning board, then bitmap will be
// displayed on LCD
//
#include <stdio.h>
#include "MCU_init.h"
#include "NUC100Series.h"
#include "SYS_init.h"
#include "LCD.h"
#include "Scankey.h"

unsigned char leftMap[] = {
    0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0xFF, 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF,
    0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF,
    0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
    0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0xFF, 0xFF, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0xFF, 0xFF, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0xFF,
    0xFF, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
    0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F,
    0x3F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x3F, 0x3F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80};

unsigned char rightMap[] = {
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
    0x60, 0x60, 0x60, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0xFF,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF};

unsigned char circle[] = {0xFF, 0x01, 0xC1, 0xF1, 0xF9, 0xF9, 0xFD, 0xFD,
                          0xFD, 0xFD, 0xF9, 0xF9, 0xF1, 0xC1, 0x01, 0xFF,
                          0xFF, 0x80, 0x83, 0x8F, 0x9F, 0x9F, 0xBF, 0xBF,
                          0xBF, 0xBF, 0x9F, 0x9F, 0x8F, 0x83, 0x80, 0xFF};

unsigned char cross[] = {0xFF, 0x11, 0x39, 0x7D, 0xF9, 0xF1, 0xE1, 0xC1,
                         0xE1, 0xF1, 0xF9, 0x7D, 0x39, 0x11, 0x01, 0xFF,
                         0xFF, 0x90, 0xB8, 0xFC, 0xBE, 0x9F, 0x8F, 0x87,
                         0x8F, 0x9F, 0xBE, 0xFC, 0xB8, 0x90, 0x80, 0xFF};

void Buzz(void)
{
    PB11 = 0;
    CLK_SysTickDelay(50000);
    PB11 = 1;
}

void rgb(int i)
{
    if (i == 0)
    {
        PA12 = 0;
        PA13 = 1;
        PA14 = 1;
    }
    else if (i == 1)
    {
        PA12 = 1;
        PA13 = 0;
        PA14 = 1;
    }
    else
    {
        PA12 = 1;
        PA13 = 1;
        PA14 = 0;
    }
}

char square[10] = {'0', '0', '0', '0', '0', '0', '0', '0', '0', '0'};
int player = 0;
int delayTime = 100000;
int winState = 0;

void placeError(void)
{
    PC15 = 0;
    CLK_SysTickDelay(delayTime);
    PC15 = 1;
    CLK_SysTickDelay(delayTime);
    PC14 = 0;
    CLK_SysTickDelay(delayTime);
    PC14 = 1;
    CLK_SysTickDelay(delayTime);
    PC13 = 0;
    CLK_SysTickDelay(delayTime);
    PC13 = 1;
    CLK_SysTickDelay(delayTime);
    PC12 = 0;
    CLK_SysTickDelay(delayTime);
    PC12 = 1;
    CLK_SysTickDelay(delayTime);
}

int checkWin(void)
{
    if (square[1] == square[2] && square[2] == square[3] && square[1] != '0')
    {
        return 1;
    }
    else if (square[4] == square[5] && square[5] == square[6] &&
             square[4] != '0')
    {
        return 1;
    }
    else if (square[7] == square[8] && square[8] == square[9] &&
             square[7] != '0')
    {
        return 1;
    }
    else if (square[1] == square[4] && square[4] == square[7] &&
             square[1] != '0')
    {
        return 1;
    }
    else if (square[2] == square[5] && square[5] == square[8] &&
             square[2] != '0')
    {
        return 1;
    }
    else if (square[3] == square[6] && square[6] == square[9] &&
             square[3] != '0')
    {
        return 1;
    }
    else if (square[1] == square[5] && square[5] == square[9] &&
             square[1] != '0')
    {
        return 1;
    }
    else if (square[3] == square[5] && square[5] == square[7] &&
             square[3] != '0')
    {
        return 1;
    }
    else if (square[1] != '0' && square[2] != '0' && square[3] != '0' &&
             square[4] != '0' && square[5] != '0' && square[6] != '0' &&
             square[7] != '0' && square[8] != '0' && square[9] != '0')
    {
        return 0;
    }
    else
    {
        return -1;
    }
}

int main(void)
{
    int i = 0;
    int j = 0;
    PD14 = 0;
    SYS_Init();
    init_LCD();
    clear_LCD();
    draw_Bmp64x64(0, 0, FG_COLOR, BG_COLOR, leftMap);
    draw_Bmp64x64(64, 0, FG_COLOR, BG_COLOR, rightMap);

    while (1)
    {
        i = 0;
        if (player % 2 == 1)
            i = ScanKey();

        PB0 = 1;
        PB1 = 1;
        PB2 = 1;
        PB2 = 1;
        PB3 = 1;
        PB4 = 1;
        PB5 = 1;
        PB6 = 1;
        PB7 = 1;
        PB8 = 1;
        PB9 = 1;

        if (i == 1 || PB1 == 0)
        {
            if (player % 2 == 1)
                PB0 = 0;
            i = 1;
        }
        else if (i == 2 || PB0 == 0)
        {
            i = 2;
            if (player % 2 == 1)
                PB1 = 0;
        }
        else if (i == 3 || PB3 == 0)
        {
            i = 3;
            if (player % 2 == 1)
                PB2 = 0;
        }
        else if (i == 4 || PB2 == 0)
        {
            i = 4;
            if (player % 2 == 1)
                PB3 = 0;
        }
        else if (i == 5 || PB5 == 0)
        {
            i = 5;
            if (player % 2 == 1)
                PB4 = 0;
        }
        else if (i == 6 || PB4 == 0)
        {
            i = 6;
            if (player % 2 == 1)
                PB5 = 0;
        }
        else if (i == 7 || PB7 == 0)
        {
            i = 7;
            if (player % 2 == 1)
                PB6 = 0;
        }
        else if (i == 8 || PB6 == 0)
        {
            i = 8;
            if (player % 2 == 1)
                PB7 = 0;
        }
        else if (i == 9 || PB9 == 0)
        {
            i = 9;
            if (player % 2 == 1)
                PB9 = 0;
        }

        if (winState == 1 && i != 0)
        {
            clear_LCD();
            draw_Bmp64x64(0, 0, FG_COLOR, BG_COLOR, leftMap);
            draw_Bmp64x64(64, 0, FG_COLOR, BG_COLOR, rightMap);
            for (j = 0; j < 10; j++)
                square[j] = '0';
            PA12 = 1;
            PA13 = 1;
            PA14 = 1;
            winState = 0;
        }

        CLK_SysTickDelay(500000);
        if (i != 0)
        {
            if (square[i] == '0')
            {
                if (player % 2 == 0)
                {
                    square[i] = 'O';
                }
                else
                {
                    square[i] = 'X';
                }
                Buzz();
                switch (i)
                {
                case 1:
                    if (player % 2 == 0)
                        draw_Bmp16x16(0, 0, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(0, 0, FG_COLOR, BG_COLOR, cross);
                    break;
                case 2:
                    if (player % 2 == 0)
                        draw_Bmp16x16(16, 0, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(16, 0, FG_COLOR, BG_COLOR, cross);
                    break;
                case 3:
                    if (player % 2 == 0)
                        draw_Bmp16x16(32, 0, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(32, 0, FG_COLOR, BG_COLOR, cross);
                    break;
                case 4:
                    if (player % 2 == 0)
                        draw_Bmp16x16(0, 15, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(0, 15, FG_COLOR, BG_COLOR, cross);
                    break;
                case 5:
                    if (player % 2 == 0)
                        draw_Bmp16x16(16, 15, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(16, 15, FG_COLOR, BG_COLOR, cross);
                    break;
                case 6:
                    if (player % 2 == 0)
                        draw_Bmp16x16(32, 15, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(32, 15, FG_COLOR, BG_COLOR, cross);
                    break;
                case 7:
                    if (player % 2 == 0)
                        draw_Bmp16x16(0, 30, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(0, 30, FG_COLOR, BG_COLOR, cross);
                    break;
                case 8:
                    if (player % 2 == 0)
                        draw_Bmp16x16(16, 30, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(16, 30, FG_COLOR, BG_COLOR, cross);
                    break;
                case 9:
                    if (player % 2 == 0)
                        draw_Bmp16x16(32, 30, FG_COLOR, BG_COLOR, circle);
                    else
                        draw_Bmp16x16(32, 30, FG_COLOR, BG_COLOR, cross);
                    break;
                }
                if (checkWin() == 1)
                {
                    if (player % 2 == 0)
                    {
                        rgb(1);
                        CLK_SysTickDelay(2000000);
                        CLK_SysTickDelay(2000000);
                        PB11 = 0;
                        CLK_SysTickDelay(80000000);
                        PB11 = 1;
                        print_Line(3, "O win");
                    }
                    else
                    {
                        rgb(0);
                        CLK_SysTickDelay(2000000);
                        CLK_SysTickDelay(2000000);
                        PB11 = 0;
                        CLK_SysTickDelay(80000000);
                        PB11 = 1;
                        print_Line(3, "X win");
                    }
                    winState = 1;
                    player = -1;
                }
                else if (checkWin() == 0)
                {
                    rgb(2);
                    CLK_SysTickDelay(2000000);
                    PB11 = 0;
                    CLK_SysTickDelay(80000000);
                    PB11 = 1;
                    print_Line(3, "tie");
                    winState = 1;
                    player = -1;
                }

                player++;
            }
            else
            {
                placeError();
                placeError();
            }
        }
    }
}
